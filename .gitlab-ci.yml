# Build script used by gitlab.medelexis.ch
stages:
    - build
    - deploy
    - trigger_other_builds

build:
  stage: build
  script:
    - xvfb-run mvn clean verify
  artifacts:
    paths:
    - ch.elexis.base.p2site/target/*.zip
    expire_in: 1 day

deploy_master_snapshot:
    stage: deploy
    script:
    - wget https://raw.githubusercontent.com/elexis/elexis-3-core/master/ch.elexis.core.releng/upload-dav.sh; chmod +x upload-dav.sh
    - mkdir upload; unzip ch.elexis.base.p2site/target/ch.elexis.base.p2site*.zip -d upload/
    - ./upload-dav.sh upload/ https://download.elexis.info/elexis/p2/ $CI_COMMIT_REF_NAME/elexis-3-base $DEPLOY_USER $DEPLOY_PASSWORD
    - rm -Rf upload/
    - rm upload-dav.sh
    environment:
        name: elexis-3-base/$CI_COMMIT_REF_NAME
        url: http://download.elexis.info/elexis/p2/$CI_COMMIT_REF_NAME/elexis-3-base
    only:
    - master

trigger_medelexis-3-application_build:
    stage: trigger_other_builds
    script:
     -  "curl -X POST -F token=$TRIGGER_TOKEN_MEDELEXIS_3_APPLICATION -F ref=$CI_COMMIT_REF_NAME https://gitlab.medelexis.ch/api/v4/projects/13/trigger/pipeline"
    only:
     - master
