<?xml version='1.0' encoding='utf-8' ?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/></head><body><h1 id="ErsteSchrittezueinerneuenElexisAuswertung" style="text-align: left;">Erste Schritte zu einer neuen Elexis Auswertung</h1><p><em>Bezeichnung:</em> Erste Schritte<br/><em>Author:</em> Thomas Huster &lt;huster@medevit.at&gt;<br/><em>Version:</em> 3.0.0, 06.11.2014<br/><em>Beschreibung:</em> Beschreibung der ersten Schritte die nötig sind um ein neues Auswertungsplugin in Elexis zu erstellen</p><h2 id="a1.Einfhrung" style="text-align: left;">1. Einführung</h2><p>Für die Auswertungen in <a href="http://elexis.info/">Elexis</a> wurde 2009 ein Framework namens <a href="http://scg.unibe.ch/archive/projects/Sche09a.pdf">Archie</a> entwickelt. Elexis basiert auf dem <a href="http://wiki.eclipse.org/Rich_Client_Platform">Eclipse RCP</a> Framework welches wiederum auf OSGi und Java aufbaut. </p><p>In der Folge wird davon ausgegangen das der Elexis Sourcecode bereits in einer <a href="https://www.eclipse.org/home/index.php">Eclipse IDE</a> verfügbar ist.</p><h2 id="a2.DasPlugin" style="text-align: left;">2. Das Plugin</h2><p>Als erstes erstellen wir ein neues <a href="http://www.vogella.com/tutorials/EclipsePlugIn/article.html">Plugin</a> in welchem die Auswertungen implementiert werden.</p><p>Auf der ersten Wizard Seite wird der Plugin Name <strong>ch.elexis.archie.example</strong> konfiguriert. Für die restlichen Einstellungen kann der default Wert übernommen werden. Auf der 2ten Wizard Seite sollte <em>Will make contributions to the UI</em> aktiviert sein, und sowohl <em>Generate an Activator, ...</em> also auch <em>Create Rich Client Platform Application</em> deaktiviert werden. Die Generierung aus einem Template kann auf der 3ten Seite deaktiviert werden.</p><p style="text-align: center;"><img border="0" src="img/NewPlugin.png"/></p><h2 id="a3.DieAbhngigkeiten" style="text-align: left;">3. Die Abhängigkeiten</h2><p>Für die folgenden Schritte ist es nötig in dem neuen Plugin zu spezifizieren welche Abhängigkeiten dieses auf die anderen Plugins und Packages hat.</p><p style="text-align: center;"><img border="0" src="img/Dependencies.png"/></p><p>Kurze Erklärung warum diese Abhängigkeiten bestehen.</p><p><strong>ch.unibe.iam.scg.archie</strong> -&gt; Die Definition des Extension Point für die Auswertung und der Klassen dafür.<br/><strong>ch.elexis.core.data</strong> -&gt; Die Definition der Daten Klassen (Patient, Mandant, Fall, Konsultation, ...) von Elexis.<br/><strong>org.eclipse.core.runtime</strong> -&gt; Die Definition von Eclipse Jobs, alle Auswertungen sind Jobs. </p><p><strong>ch.rgw.tools</strong> -&gt; Utilities (TimeTool, ...) und Definition die bei der Verwendung von Elexis Daten Klassen benötigt werden.</p><h2 id="a4.DerExtensionPoint" style="text-align: left;">4. Der Extension Point</h2><p>Das Konzept von <a href="http://www.vogella.com/tutorials/EclipseExtensionPoint/article.html">Extensions Points</a> ermöglicht es uns das Plugin <strong>ch.unibe.iam.scg.archie</strong> mit eigenen Auswertungen zu erweitern. Der dafür vorgesehene Extension Point hat die Id <strong>ch.unibe.iam.scg.archie.dataprovider</strong>. In diesem Extension Point können DataProvider Elemente angelegt werden (Kontextmenu &gt; New &gt; DataProvider).</p><p style="text-align: center;"><img border="0" src="img/ExtensionPoint.png"/> </p><p>Durch Klick auf den <em>class*</em> Link neben dem Namen der neuen Klasse in der die Auswertung implementiert wird kann die Klasse direkt angelegt werden.</p><p style="text-align: center;"><img border="0" src="img/ExampleDataproviderEmpty.png"/></p><h2 id="a4.DerCode" style="text-align: left;">4. Der Code</h2><p>Unsere Auswertung soll alle innerhalb eines Zeitraums verrechneten Leistungen anzeigen. </p><p>Jede Auswertung muss in der <strong>List<String> createHeadings()</strong> Methode bekannt geben welche Spalten benötigt werden. </p><p>Für Auswertungen welche die Angabe eines Zeitraums benötigen wurde die Klasse <strong>ch.unibe.iam.scg.archie.model.AbstractTimeSeries</strong> erstellt. Alle abgeleiteten Klassen haben die dazu benötigten Eingabefelder, und können mittels <strong>this.getStartDate()</strong> und <strong>this.getEndDate()</strong> auf die Werte zugreifen.</p><p><pre><br/>		TimeTool ttStart = new TimeTool(this.getStartDate().getTimeInMillis());<br/>		TimeTool ttEnd = new TimeTool(this.getEndDate().getTimeInMillis());<br/></pre></p><p>In Elexis wird die <strong>Query</strong> Klasse dazu verwendet Abfragen an die Datenbank zu stellen.</p><p><pre><br/>		Query<Konsultation> qbe = new Query<Konsultation>(Konsultation.class);<br/>		qbe.add(Konsultation.FLD_DATE, Query.GREATER_OR_EQUAL,<br/>			ttStart.toString(TimeTool.DATE_COMPACT));<br/>		qbe.add(Konsultation.FLD_DATE, Query.LESS_OR_EQUAL,<br/>			ttEnd.toString(TimeTool.DATE_COMPACT));<br/>		List<Konsultation> consultations = qbe.execute();<br/></pre> </p><p>Die Daten werden als eine Liste von Arrays von Comparable erstellt, und mittels der setContent der lokalen Variable dataSet zugewiesen.</p><p><pre><br/>		// erstellen der Liste von Arrays<br/>		final ArrayList&lt;Comparable&lt;?&gt;[]&gt; result = new ArrayList&lt;Comparable&lt;?&gt;[]&gt;();<br/>		.<br/>		.<br/>		.<br/>						// erstellen eines Arrays für jede Zeile<br/>						Comparable&lt;?&gt;[] row = new Comparable&lt;?&gt;[this.dataSet.getHeadings().size()];<br/>		.<br/>		.<br/>		.				<br/>		// übergabe der gesammelten Daten<br/>		this.dataSet.setContent(result);<br/></pre></p><p>Die komplette Implementierung für das ermitteln von Arzt, Datum, Pat Id, Behandlung und Preis aller verrechneten Leistungen in einem Zeitraum sieht dann wie folgt aus.</p><p><pre><br/>package ch.elexis.archie.example;</p><p>import java.util.ArrayList;<br/>import java.util.List;</p><p>import org.eclipse.core.runtime.IProgressMonitor;<br/>import org.eclipse.core.runtime.IStatus;<br/>import org.eclipse.core.runtime.Status;</p><p>import ch.elexis.data.AccountTransaction;<br/>import ch.elexis.data.Konsultation;<br/>import ch.elexis.data.Mandant;<br/>import ch.elexis.data.Patient;<br/>import ch.elexis.data.Query;<br/>import ch.elexis.data.Verrechnet;<br/>import ch.rgw.tools.TimeTool;<br/>import ch.unibe.iam.scg.archie.model.AbstractTimeSeries;</p><p>public class ExampleDataProvider extends AbstractTimeSeries {</p><p>	public ExampleDataProvider(){<br/>		super(&#8222;Beispiel Auswertung&#8221;);<br/>	}</p><p>	@Override<br/>	public String getDescription(){<br/>		return &#8222;Beispiel Auswertung&#8221;;<br/>	}</p><p>	@Override<br/>	protected List<String> createHeadings(){<br/>		List<String> ret = new ArrayList<String>();<br/>		ret.add(&#8222;Arzt&#8221;);<br/>		ret.add(&#8222;Datum&#8221;);<br/>		ret.add(&#8222;Pat Id&#8221;);<br/>		ret.add(&#8222;Behandlung&#8221;);<br/>		ret.add(&#8222;Preis&#8221;);<br/>		return ret;<br/>	}</p><p>	@Override<br/>	protected IStatus createContent(IProgressMonitor monitor){<br/>		monitor.beginTask(&#8222;Beispiel Auswertung&#8221;, IProgressMonitor.UNKNOWN);<br/>		Query<Konsultation> qbe = new Query<Konsultation>(Konsultation.class);<br/>		TimeTool ttStart = new TimeTool(this.getStartDate().getTimeInMillis());<br/>		TimeTool ttEnd = new TimeTool(this.getEndDate().getTimeInMillis());<br/>		qbe.add(Konsultation.FLD_DATE, Query.GREATER_OR_EQUAL,<br/>			ttStart.toString(TimeTool.DATE_COMPACT));<br/>		qbe.add(Konsultation.FLD_DATE, Query.LESS_OR_EQUAL,<br/>			ttEnd.toString(TimeTool.DATE_COMPACT));<br/>		monitor.subTask(&#8222;Lade Konsultationen&#8221;);<br/>		List<Konsultation> consultations = qbe.execute();</p><p>		final ArrayList&lt;Comparable&lt;?&gt;[]&gt; result = new ArrayList&lt;Comparable&lt;?&gt;[]&gt;();</p><p>		for (Konsultation cons : consultations) {<br/>			if (cons.getFall() != null) {<br/>				Patient patient = cons.getFall().getPatient();<br/>				Mandant mandant = cons.getMandant();<br/>				List<Verrechnet> activities = cons.getLeistungen();<br/>				if (mandant != null &amp;&amp; patient != null &amp;&amp; activities != null<br/>					&amp;&amp; !activities.isEmpty()) {<br/>					for (Verrechnet verrechnet : activities) {<br/>						Comparable&lt;?&gt;[] row = new Comparable&lt;?&gt;[this.dataSet.getHeadings().size()];<br/>						int index = 0;</p><p>						row[index++] = mandant.getMandantLabel();<br/>						row[index++] = cons.getDatum();<br/>						row[index++] = patient.get(Patient.FLD_PATID);<br/>						row[index++] = verrechnet.getText();<br/>						row[index++] = verrechnet.getNettoPreis().toString();</p><p>						result.add(row);</p><p>						if (monitor.isCanceled()) {<br/>							return Status.CANCEL_STATUS;<br/>						}<br/>					}<br/>				}<br/>			}<br/>		}<br/>		// Set content.<br/>		this.dataSet.setContent(result);</p><p>		// Job finished successfully<br/>		monitor.done();</p><p>		return Status.OK_STATUS;<br/>	}<br/>}<br/></pre></p><h2 id="a5.DieRunConfiguration" style="text-align: left;">5. Die Run Configuration</h2><p>Für das Starten von Applikationen aus Eclipse wird eine Run Configuration benötigt. Damit das neue Plugin ausgeführt wird, muss dieses in diese mit aufgenommen werden. Da das Plugin in keinem Feature enthalten ist, muss die Konfiguration auf Plugins basieren (Launch with: Plugins selected below only). Durch ausführen von <em>Add Required Plug-ins</em> werden automatisch zusätzlich benötigte Plugins in die Konfiguration aufgenommen.</p><p style="text-align: center;"><img border="0" src="img/RunConfiguration.png"/></p><h2 id="a6.DielaufendeAuswertung" style="text-align: left;">6. Die laufende Auswertung</h2><p>Wenn das Plugin mit gestartet wird ist die <strong>Beispiel Auswertung</strong> in der Seitenleiste View der Archie Perspektive auswählbar.</p><p style="text-align: center;"><img border="0" src="img/SeitenleisteAuswahl.png"/></p><p>Die Auswertung kann mittels <strong>Abfrage Starten</strong>, nach der Auswahl eines sinnvollen Zeitbereichs, gestartet werden. Je nach Datensatz und Zeitbereich dauert das Zusammenstellen der Datenzeilen, bevor die Tabelle mit den Ergebnissen angezeigt wird.</p><p style="text-align: center;"><img border="0" src="img/AuswertungFertig.png"/></p></body></html>